{% extends "base.html" %}
{% load custom_filters %}
{% block title %}–¢–∞–±–µ–ª—å{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-4 text-black">–¢–∞–±–µ–ª—å –∑–∞ {{ month|date:"F Y" }}</h1>

<!-- –®–ø–∞—Ä–≥–∞–ª–∫–∞ -->
<div class="mb-2 text-sm text-gray-700">
  <span class="inline-block mr-4"><span class="font-bold text-green-700">–î</span> ‚Äî –î–µ–Ω—å</span>
  <span class="inline-block mr-4"><span class="font-bold text-blue-700">–ù</span> ‚Äî –ù–æ—á—å</span>
  <span class="inline-block mr-4"><span class="font-bold text-gray-500">–í</span> ‚Äî –í—ã—Ö–æ–¥–Ω–æ–π</span>
  <span class="inline-block mr-4"><span class="font-bold text-yellow-600">–û</span> ‚Äî –û—Ç–ø—É—Å–∫</span>
  <span class="inline-block"><span class="font-bold text-red-600">–ë</span> ‚Äî –ë–æ–ª—å–Ω–∏—á–Ω—ã–π</span>
</div>

<!-- –§–∏–ª—å—Ç—Ä -->
<form method="get" class="mb-4 flex flex-wrap gap-4 items-center text-sm">
  <label class="font-semibold">–ú–µ—Å—è—Ü:
    <input type="month" name="month" value="{{ month|date:'Y-m' }}" class="border rounded px-2 py-1 text-sm">
  </label>
  <label class="font-semibold">–û—Ç–¥–µ–ª:
    <select name="department" class="border rounded px-2 py-1 text-sm">
      <option value="">–í—Å–µ</option>
      {% for dept in departments %}
        <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>{{ dept.name }}</option>
      {% endfor %}
    </select>
  </label>
  <button type="submit" class="px-4 py-2 rounded text-white bg-[var(--bianca-orange)] hover:bg-orange-600 font-semibold">–ü–æ–∫–∞–∑–∞—Ç—å</button>
  <button type="button" onclick="openAutoFillModal()" class="px-4 py-2 rounded text-white bg-gray-700 hover:bg-gray-800 font-semibold">‚öô –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—å</button>
</form>

<!-- –¢–∞–±–µ–ª—å -->
<form method="POST">
  {% csrf_token %}
  <div class="overflow-x-auto border rounded-lg shadow">
    <table class="table-auto min-w-full border-collapse text-xs">
      <thead class="bg-gray-100 text-gray-800">
        <tr>
        </tr>
      </thead>
      <tbody>
        {% for employee in employees %}
        <tr class="hover:bg-gray-50 text-sm">
          <td class="border px-3 py-1 text-left whitespace-nowrap text-black">{{ employee.full_name }}</td>
              <div class="relative">
                {% with val=schedule|get_item:employee.id|get_item:info.num %}
                  <button type="button"
                          class="shift-button rounded w-[32px] h-[28px] text-xs font-semibold bg-gray-100"
                          data-emp="{{ employee.id }}" data-day="{{ info.num }}">
                    {% for key, label in shift_choices %}{% if key == val %}{{ label }}{% endif %}{% endfor %}
                  </button>
                  <input type="hidden" name="shift_{{ employee.id }}_{{ info.num }}" value="{{ val }}">
                {% endwith %}
                <div class="shift-popover hidden absolute top-full left-0 mt-1 bg-white border rounded shadow text-xs z-50">
                  {% for key, label in shift_choices %}
                    <div class="cursor-pointer px-2 py-1 hover:bg-gray-100" data-value="{{ key }}" data-label="{{ label }}">{{ label }}</div>
                  {% endfor %}
                </div>
              </div>
            </td>
          {% endfor %}
          <td class="border px-1 py-1 text-center bg-green-100 font-semibold">{{ salary|get_item:employee.id|get_item:"day" }}</td>
          <td class="border px-1 py-1 text-center bg-blue-100 font-semibold">{{ salary|get_item:employee.id|get_item:"night" }}</td>
          <td class="border px-1 py-1 text-center font-bold bg-yellow-100 text-black">
            {{ salary|get_item:employee.id|get_item:"total"|floatformat:0 }} ‚ÇΩ
          </td>
        </tr>
        {% if employee.is_fixed_salary %}
        <tr class="text-xs text-gray-500 italic bg-gray-100">
          <td colspan="{{ days|length|add:'4' }}" class="px-2 py-1 text-left">
            ‚öô –û–∫–ª–∞–¥: {{ employee.fixed_salary|floatformat:0 }} ‚ÇΩ +
            –ü—Ä–µ–º–∏—è: {{ employee.bonus|floatformat:0 }} ‚ÇΩ (—Ä–∞—Å—á—ë—Ç –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–º–µ–Ω)
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <div class="mt-4 flex items-center">
    <button type="submit" class="px-4 py-2 bg-[var(--bianca-orange)] text-white rounded hover:bg-orange-600">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–±–µ–ª—å</button>
    <a href="{% url 'export_timesheet' %}?month={{ month|date:'Y-m' }}{% if selected_department %}&department={{ selected_department }}{% endif %}"
       class="ml-4 px-4 py-2 bg-black text-white rounded hover:bg-gray-800">üì• –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</a>
  </div>
</form>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="autofill-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white p-6 rounded shadow-lg w-[300px]">
    <h2 class="text-lg font-bold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –≥—Ä–∞—Ñ–∏–∫–∞</h2>
    <select id="schedule-template" class="w-full border px-2 py-1 mb-4">
      <option value="2_2">2/2 (–¥–µ–Ω—å/–¥–µ–Ω—å/–≤—ã—Ö/–≤—ã—Ö)</option>
      <option value="5_2">5/2 (–ø–Ω‚Äì–ø—Ç ‚Äî –¥–µ–Ω—å, —Å–±/–≤—Å ‚Äî –≤—ã—Ö–æ–¥–Ω–æ–π)</option>
      <option value="night_3_3">3/3 (–Ω–æ—á—å/–Ω–æ—á—å/–Ω–æ—á—å/–≤—ã—Ö/–≤—ã—Ö/–≤—ã—Ö)</option>
    </select>
    <div class="flex justify-end space-x-2">
      <button onclick="closeAutoFillModal()" class="text-gray-600">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="applyAutoFill()" class="text-white bg-[var(--bianca-orange)] px-3 py-1 rounded hover:bg-orange-600">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
const lastShifts = {
  {% for emp in employees %}
    {{ emp.id }}: "{{ last_shifts|get_item:emp.id|default_if_none:'' }}",
  {% endfor %}
};

document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".shift-button").forEach(button => {
    const container = button.parentElement;
    const popover = container.querySelector(".shift-popover");
    const hiddenInput = container.querySelector("input");

    button.addEventListener("click", () => {
      document.querySelectorAll(".shift-popover").forEach(p => p.classList.add("hidden"));
      popover.classList.remove("hidden");
    });

    popover.querySelectorAll("div[data-value]").forEach(option => {
      option.addEventListener("click", () => {
        hiddenInput.value = option.dataset.value;
        button.textContent = option.dataset.label;
        popover.classList.add("hidden");
      });
    });
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".relative")) {
      document.querySelectorAll(".shift-popover").forEach(p => p.classList.add("hidden"));
    }
  });
});

function openAutoFillModal() {
  document.getElementById("autofill-modal").classList.remove("hidden");
}
function closeAutoFillModal() {
  document.getElementById("autofill-modal").classList.add("hidden");
}
function applyAutoFill() {
  const template = document.getElementById("schedule-template").value;
  const monthStart = "{{ month|date:'Y-m' }}";
  const labelMap = { day: "–î", night: "–ù", weekend: "–í", vacation: "–û", sick: "–ë" };

  document.querySelectorAll("input[name^='shift_']").forEach(input => {
    const parts = input.name.split("_");
    const empId = parts[1];
    const day = parseInt(parts[2]);

    let shift = "";
    let offset = 0;

    if (template === "2_2") {
      const cycle = ["day", "day", "weekend", "weekend"];
      const prev = lastShifts[empId];
      offset = cycle.includes(prev) ? (cycle.indexOf(prev) + 1) % cycle.length : 0;
      shift = cycle[(offset + day - 1) % cycle.length];
    }
    if (template === "5_2") {
      const d = new Date(`${monthStart}-${String(day).padStart(2, '0')}`);
      shift = (d.getDay() === 0 || d.getDay() === 6) ? "weekend" : "day";
    }
    if (template === "night_3_3") {
      const cycle = ["night", "night", "night", "weekend", "weekend", "weekend"];
      const prev = lastShifts[empId];
      offset = cycle.includes(prev) ? (cycle.indexOf(prev) + 1) % cycle.length : 0;
      shift = cycle[(offset + day - 1) % cycle.length];
    }

    input.value = shift;
    const button = input.parentElement.querySelector(".shift-button");
    if (button) button.textContent = labelMap[shift] || "";
  });

  closeAutoFillModal();
}
</script>
{% endblock %}
