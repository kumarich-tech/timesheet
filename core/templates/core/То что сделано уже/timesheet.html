{% extends "base.html" %}
{% block title %}–¢–∞–±–µ–ª—å{% endblock %}
{% load custom_filters %}

{% block content %}
<h1 class="text-3xl font-bold mb-4 text-black">–¢–∞–±–µ–ª—å –∑–∞ {{ month|date:"F Y" }}</h1>

<!-- –®–ø–∞—Ä–≥–∞–ª–∫–∞ -->
<div class="mb-2 text-sm text-gray-700">
  <span class="inline-block mr-4"><span class="font-bold text-green-700">–î</span> ‚Äî –î–µ–Ω—å</span>
  <span class="inline-block mr-4"><span class="font-bold text-blue-700">–ù</span> ‚Äî –ù–æ—á—å</span>
  <span class="inline-block mr-4"><span class="font-bold text-gray-500">–í</span> ‚Äî –í—ã—Ö–æ–¥–Ω–æ–π</span>
  <span class="inline-block mr-4"><span class="font-bold text-yellow-600">–û</span> ‚Äî –û—Ç–ø—É—Å–∫</span>
  <span class="inline-block"><span class="font-bold text-red-600">–ë</span> ‚Äî –ë–æ–ª—å–Ω–∏—á–Ω—ã–π</span>
</div>

<!-- –§–∏–ª—å—Ç—Ä -->
<form method="get" class="mb-4 flex flex-wrap gap-4 items-center text-sm">
  <label class="font-semibold">–ú–µ—Å—è—Ü:
    <input type="month" name="month" value="{{ month|date:'Y-m' }}"
           class="border rounded px-2 py-1 text-sm">
  </label>
  <label class="font-semibold">–û—Ç–¥–µ–ª:
    <select name="department" class="border rounded px-2 py-1 text-sm">
      <option value="">–í—Å–µ</option>
      {% for dept in departments %}
        <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
          {{ dept.name }}
        </option>
      {% endfor %}
    </select>
  </label>
  <button type="submit" class="px-4 py-2 rounded text-white bg-[var(--bianca-orange)] hover:bg-orange-600 font-semibold">
    –ü–æ–∫–∞–∑–∞—Ç—å
  </button>
</form>

<!-- –¢–∞–±–µ–ª—å -->
<form method="POST">
  {% csrf_token %}
  <div class="overflow-x-auto border rounded-lg shadow-xs">
    <table class="table-auto min-w-full border-collapse text-xs">
      <thead class="bg-gray-100 text-gray-800">
        <tr>
          <th class="border px-2 py-2 text-left w-[200px] font-semibold">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
          {% for day in days %}
            <th class="border px-2 py-2 text-center w-[48px] font-sm">{{ day }}</th>
          {% endfor %}
          <th class="border px-1 py-1 text-center w-[40px] font-semibold">–î–µ–Ω—å</th>
          <th class="border px-1 py-1 text-center w-[40px] font-semibold">–ù–æ—á—å</th>
          <th class="border px-1 py-1 text-center w-[70px] font-semibold">–ò—Ç–æ–≥–æ</th>
        </tr>
      </thead>
      <tbody>
        {% for employee in employees %}
          <tr class="hover:bg-gray-50 text-sm">
            <td class="border px-3 py-1 text-left whitespace-nowrap text-black">{{ employee.full_name }}</td>
            {% for day in days %}
              <td class="border px-1 py-1 text-center">
                <div class="shift-cell w-8 h-6 rounded cursor-pointer bg-white border text-xs flex items-center justify-center"
                     data-emp="{{ employee.id }}" data-day="{{ day }}"
                     data-value="{{ schedule|get_item:employee.id|get_item:day }}">
                  {{ schedule|get_item:employee.id|get_item:day|get_shift_label }}
                </div>
                <input type="hidden" name="shift_{{ employee.id }}_{{ day }}"
                       value="{{ schedule|get_item:employee.id|get_item:day }}">
              </td>
            {% endfor %}
            <td class="border px-1 py-1 text-center bg-green-100 font-semibold">{{ salary|get_item:employee.id|get_item:"day" }}</td>
            <td class="border px-1 py-1 text-center bg-blue-100 font-semibold">{{ salary|get_item:employee.id|get_item:"night" }}</td>
            <td class="border px-1 py-1 text-center font-bold bg-yellow-100 text-black">
              {{ salary|get_item:employee.id|get_item:"total"|floatformat:0 }} ‚ÇΩ
            </td>
          </tr>
        {% endfor %}
        {% if employee.is_fixed_salary %}
          <tr class="text-xs text-gray-500 italic bg-gray-100">
            <td colspan="{{ days|length|add:'4' }}" class="px-2 py-1 text-left">
              ‚öô –û–∫–ª–∞–¥: {{ employee.fixed_salary|floatformat:0 }} ‚ÇΩ +
              –ü—Ä–µ–º–∏—è: {{ employee.bonus|floatformat:0 }} ‚ÇΩ (—Ä–∞—Å—á—ë—Ç –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–º–µ–Ω)
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <div class="mt-4 flex items-center">
    <button type="submit" class="px-4 py-2 bg-[var(--bianca-orange)] text-white rounded hover:bg-orange-600">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–±–µ–ª—å
    </button>
    <a href="{% url 'export_timesheet' %}?month={{ month|date:'Y-m' }}{% if selected_department %}&department={{ selected_department }}{% endif %}"
       class="ml-4 px-4 py-2 bg-black text-white rounded hover:bg-gray-800">
      üì• –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel
    </a>
  </div>
</form>

<script>
const shiftCycle = ["", "day", "night", "weekend", "vacation", "sick"];
const shiftSymbols = {
  "": "", "day": "üåû", "night": "üåô",
  "weekend": "‚õ±", "vacation": "‚úàÔ∏è", "sick": "üíä"
};

document.querySelectorAll(".shift-cell").forEach(cell => {
  cell.addEventListener("click", () => {
    const emp = cell.dataset.emp;
    const day = cell.dataset.day;
    const current = cell.dataset.value;
    const nextIndex = (shiftCycle.indexOf(current) + 1) % shiftCycle.length;
    const nextValue = shiftCycle[nextIndex];

    cell.dataset.value = nextValue;
    cell.textContent = shiftSymbols[nextValue] || "";

    const hiddenInput = document.querySelector(`input[name="shift_${emp}_${day}"]`);
    if (hiddenInput) hiddenInput.value = nextValue;
  });
});
</script>
{% endblock %}
